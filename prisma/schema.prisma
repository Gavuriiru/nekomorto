generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model PostRecord {
  id          String    @id
  position    Int       @default(0)
  slug        String    @unique
  projectId   String    @default("")
  status      String    @default("draft")
  publishedAt DateTime?
  deletedAt   DateTime?
  data        Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([position])
  @@index([status])
  @@map("posts")
}

model PostVersionRecord {
  id          String   @id
  postId       String
  position     Int      @default(0)
  versionNumber Int
  reason       String
  label        String?
  actorId      String?
  actorName    String?
  slug         String
  createdAt    DateTime
  data         Json

  @@index([position])
  @@index([postId, createdAt])
  @@index([postId, versionNumber])
  @@map("post_versions")
}

model ProjectRecord {
  id        String    @id
  position  Int       @default(0)
  deletedAt DateTime?
  data      Json
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([position])
  @@map("projects")
}

model UserRecord {
  id         String   @id
  position   Int      @default(0)
  accessRole String?
  status     String?
  data       Json
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([position])
  @@index([accessRole])
  @@map("users")
}

model CommentRecord {
  id         String    @id
  position   Int       @default(0)
  targetType String
  targetId   String
  status     String
  createdAt  DateTime?
  data       Json
  updatedAt  DateTime  @updatedAt

  @@index([position])
  @@index([targetType, targetId])
  @@map("comments")
}

model UpdateRecord {
  id        String    @id
  position  Int       @default(0)
  projectId String
  updatedAt DateTime?
  data      Json

  @@index([position])
  @@index([projectId])
  @@map("updates")
}

model UploadRecord {
  id        String    @id
  position  Int       @default(0)
  url       String    @unique
  folder    String
  createdAt DateTime?
  data      Json
  updatedAt DateTime  @updatedAt

  @@index([position])
  @@index([folder])
  @@map("uploads")
}

model LinkTypeRecord {
  id       String   @id
  position Int      @default(0)
  label    String
  icon     String
  data     Json
  updatedAt DateTime @updatedAt

  @@index([position])
  @@map("link_types")
}

model OwnerIdRecord {
  userId   String @id
  position Int    @unique

  @@index([position])
  @@map("owner_ids")
}

model AllowedUserRecord {
  userId   String @id
  position Int    @default(0)

  @@index([position])
  @@map("allowed_users")
}

model SiteSettingsRecord {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt

  @@map("site_settings")
}

model IntegrationSettingsRecord {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt

  @@map("integration_settings")
}

model PagesRecord {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt

  @@map("pages")
}

model TagTranslationsRecord {
  id        Int      @id @default(1)
  data      Json
  updatedAt DateTime @updatedAt

  @@map("tag_translations")
}

model AuditLogRecord {
  id        String   @id
  position  Int      @default(0)
  ts        DateTime
  actorId   String
  actorName String
  ip        String
  action    String
  resource  String
  resourceId String?
  status    String
  requestId String?
  data      Json

  @@index([position])
  @@index([ts])
  @@index([action])
  @@map("audit_logs")
}

model AnalyticsEventRecord {
  id              String   @id
  position        Int      @default(0)
  ts              DateTime
  day             String
  eventType       String
  resourceType    String
  resourceId      String
  visitorHash     String
  referrerHost    String
  isAuthenticated Boolean  @default(false)
  data            Json

  @@index([position])
  @@index([day])
  @@index([resourceType, resourceId])
  @@index([ts])
  @@map("analytics_events")
}

model AnalyticsDailyRecord {
  id            Int      @id @default(1)
  schemaVersion Int
  generatedAt   DateTime
  data          Json
  updatedAt     DateTime @updatedAt

  @@map("analytics_daily")
}

model AnalyticsMetaRecord {
  id                   Int      @id @default(1)
  schemaVersion        Int
  retentionDays        Int
  aggregateRetentionDays Int
  updatedAt            DateTime
  data                 Json

  @@map("analytics_meta")
}

model UserSessionRecord {
  sid    String   @id @db.VarChar(255)
  sess   Json
  expire DateTime @db.Timestamp(6)

  @@index([expire], map: "idx_user_sessions_expire")
  @@map("user_sessions")
}

model UserMfaTotpRecord {
  userId              String   @id
  secretEncrypted     String
  secretKeyId         String
  enabledAt           DateTime?
  disabledAt          DateTime?
  recoveryCodesHashed Json
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("user_mfa_totp")
}

model UserSessionIndexRecord {
  sid          String   @id @db.VarChar(255)
  userId       String
  createdAt    DateTime @default(now())
  lastSeenAt   DateTime
  lastIp       String?
  userAgent    String?
  revokedAt    DateTime?
  revokedBy    String?
  revokeReason String?
  isPendingMfa Boolean  @default(false)

  @@index([userId], map: "user_session_index_userId_idx")
  @@index([lastSeenAt], map: "user_session_index_lastSeenAt_idx")
  @@index([revokedAt], map: "user_session_index_revokedAt_idx")
  @@map("user_session_index")
}

model SecurityEventRecord {
  id           String   @id
  ts           DateTime @default(now())
  type         String
  severity     String
  riskScore    Int      @default(0)
  status       String
  actorUserId  String?
  targetUserId String?
  ip           String?
  userAgent    String?
  sessionId    String?
  requestId    String?
  data         Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([ts], map: "security_events_ts_idx")
  @@index([status], map: "security_events_status_idx")
  @@index([severity], map: "security_events_severity_idx")
  @@index([type], map: "security_events_type_idx")
  @@index([actorUserId], map: "security_events_actorUserId_idx")
  @@index([targetUserId], map: "security_events_targetUserId_idx")
  @@map("security_events")
}

model AdminExportJobRecord {
  id          String   @id
  dataset     String
  format      String
  status      String
  requestedBy String
  filters     Json
  filePath    String?
  rowCount    Int?
  error       String?
  createdAt   DateTime @default(now())
  startedAt   DateTime?
  finishedAt  DateTime?
  expiresAt   DateTime?
  updatedAt   DateTime @updatedAt

  @@index([status], map: "admin_export_jobs_status_idx")
  @@index([createdAt], map: "admin_export_jobs_createdAt_idx")
  @@index([requestedBy], map: "admin_export_jobs_requestedBy_idx")
  @@map("admin_export_jobs")
}

model SecretRotationRecord {
  id           String   @id
  secretFamily String
  keyId        String
  rotatedAt    DateTime
  rotatedBy    String
  notes        String?
  status       String
  createdAt    DateTime @default(now())

  @@index([secretFamily, rotatedAt], map: "secret_rotations_family_rotatedAt_idx")
  @@map("secret_rotations")
}

model UserPreferenceRecord {
  userId    String   @id
  data      Json
  updatedAt DateTime @updatedAt

  @@map("user_preferences")
}
