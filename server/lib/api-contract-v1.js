export const API_CONTRACT_VERSION = "v1";

const CONTRACT_BASE = Object.freeze({
  version: API_CONTRACT_VERSION,
  compatibility: {
    backwardCompatibleWith: ["v1"],
    deprecates: [
      {
        method: "GET",
        path: "/api/audit-log?format=csv",
        replacement: "POST /api/admin/exports + GET /api/admin/exports/:id/download",
        status: "deprecated",
      },
    ],
  },
  notes: [
    "Endpoints de escrita aceitam Idempotency-Key opcional para deduplicacao segura.",
    "Rate limit usa backend Redis quando configurado (fallback local em memoria).",
    "Fluxo MFA opcional usa pending_mfa; finalize em POST /api/auth/mfa/verify.",
    "Endpoints publicos de conteudo expÃµem mediaVariants (mapa de URL para avif/webp/fallback).",
    "Endpoints de upload podem retornar variantsGenerated e variantGenerationError para observabilidade.",
  ],
  endpoints: [
    {
      method: "GET",
      path: "/api/public/bootstrap",
      auth: "public",
      cache: "public-read",
      responseExtends: ["mediaVariants"],
    },
    {
      method: "GET",
      path: "/api/public/search/suggest",
      auth: "public",
      cache: "public-read",
    },
    {
      method: "GET",
      path: "/api/public/projects",
      auth: "public",
      cache: "public-read",
      responseExtends: ["mediaVariants"],
    },
    {
      method: "GET",
      path: "/api/public/posts",
      auth: "public",
      cache: "public-read",
      responseExtends: ["mediaVariants"],
    },
    {
      method: "GET",
      path: "/api/public/posts/:slug",
      auth: "public",
      cache: "public-read",
      responseExtends: ["mediaVariants"],
    },
    {
      method: "GET",
      path: "/api/public/projects/:id",
      auth: "public",
      cache: "public-read",
      responseExtends: ["mediaVariants"],
    },
    {
      method: "POST",
      path: "/api/public/comments",
      auth: "public",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/uploads/image",
      auth: "session",
      idempotent: "optional_by_header",
      responseExtends: ["variantsGenerated", "variantGenerationError?"],
    },
    {
      method: "POST",
      path: "/api/uploads/image-from-url",
      auth: "session",
      idempotent: "optional_by_header",
      responseExtends: ["variantsGenerated", "variantGenerationError?"],
    },
    {
      method: "PATCH",
      path: "/api/uploads/:id/focal-point",
      auth: "session",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/uploads/storage/areas",
      auth: "session",
      cache: "no-store",
    },
    {
      method: "GET",
      path: "/api/me/security",
      auth: "session",
      cache: "no-store",
    },
    {
      method: "POST",
      path: "/api/me/security/totp/enroll/start",
      auth: "session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/me/security/totp/enroll/confirm",
      auth: "session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/me/security/totp/disable",
      auth: "session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/me/sessions",
      auth: "session",
      cache: "no-store",
    },
    {
      method: "GET",
      path: "/api/dashboard/notifications",
      auth: "session",
      cache: "no-store",
    },
    {
      method: "DELETE",
      path: "/api/me/sessions/:sid",
      auth: "session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "DELETE",
      path: "/api/me/sessions/others",
      auth: "session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/auth/mfa/verify",
      auth: "pending_mfa_session",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/admin/security/events",
      auth: "admin_or_owner",
      cache: "no-store",
    },
    {
      method: "POST",
      path: "/api/admin/security/events/:id/ack",
      auth: "admin_or_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/admin/security/events/:id/resolve",
      auth: "admin_or_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/admin/security/events/:id/ignore",
      auth: "admin_or_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/admin/sessions/active",
      auth: "owner_only",
      cache: "no-store",
    },
    {
      method: "GET",
      path: "/api/admin/users/:id/sessions",
      auth: "owner_only",
      cache: "no-store",
    },
    {
      method: "DELETE",
      path: "/api/admin/users/:id/sessions/:sid",
      auth: "owner_only",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/admin/users/:id/security/totp/reset",
      auth: "owner_only",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "POST",
      path: "/api/admin/exports",
      auth: "admin_or_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/admin/exports",
      auth: "admin_or_owner",
      cache: "no-store",
    },
    {
      method: "GET",
      path: "/api/admin/exports/:id",
      auth: "admin_or_owner",
      cache: "no-store",
    },
    {
      method: "GET",
      path: "/api/admin/exports/:id/download",
      auth: "admin_or_owner",
      cache: "no-store",
    },
    {
      method: "DELETE",
      path: "/api/admin/exports/:id",
      auth: "admin_or_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/admin/security/rotation",
      auth: "admin_or_owner",
      cache: "no-store",
    },
    {
      method: "POST",
      path: "/api/admin/security/rotation",
      auth: "primary_owner",
      cache: "no-store",
      idempotent: "optional_by_header",
    },
    {
      method: "GET",
      path: "/api/metrics",
      auth: "internal_token",
      cache: "no-store",
    },
  ],
});

export const buildApiContractV1 = () => ({
  ...CONTRACT_BASE,
  generatedAt: new Date().toISOString(),
});


