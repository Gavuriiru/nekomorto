name: Deploy Production

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Optional image tag to deploy (latest or sha-<40hex>). Leave empty to deploy current commit."
        required: false
        type: string

concurrency:
  group: deploy-production
  cancel-in-progress: true

jobs:
  build_and_push:
    if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.image_tag == '') }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push app image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          platforms: linux/amd64
          push: true
          tags: |
            ghcr.io/gavuriiru/nekomorto:latest
            ghcr.io/gavuriiru/nekomorto:sha-${{ github.sha }}

  deploy:
    needs:
      - build_and_push
    if: ${{ always() && (needs.build_and_push.result == 'success' || needs.build_and_push.result == 'skipped') }}
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - name: Resolve image tag
        id: resolve-image
        shell: bash
        env:
          INPUT_TAG: ${{ github.event.inputs.image_tag || '' }}
        run: |
          if [ -n "${INPUT_TAG}" ]; then
            if [[ ! "${INPUT_TAG}" =~ ^(latest|sha-[0-9a-f]{40})$ ]]; then
              echo "Invalid image_tag: ${INPUT_TAG}" >&2
              echo "Allowed values: latest or sha-<40 lowercase hex chars>" >&2
              exit 1
            fi
            RESOLVED_TAG="${INPUT_TAG}"
          else
            RESOLVED_TAG="sha-${{ github.sha }}"
          fi

          echo "image_repo=ghcr.io/gavuriiru/nekomorto" >> "${GITHUB_OUTPUT}"
          echo "image_tag=${RESOLVED_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Configure SSH
        shell: bash
        run: |
          PORT="${{ secrets.PROD_PORT }}"
          if [ -z "${PORT}" ]; then
            PORT=22
          fi

          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${PORT}" "${{ secrets.PROD_HOST }}" >> ~/.ssh/known_hosts

      - name: Run remote deploy
        shell: bash
        run: |
          PORT="${{ secrets.PROD_PORT }}"
          if [ -z "${PORT}" ]; then
            PORT=22
          fi

          IMAGE_REPO="${{ steps.resolve-image.outputs.image_repo }}"
          IMAGE_TAG="${{ steps.resolve-image.outputs.image_tag }}"

          ssh -o StrictHostKeyChecking=yes -p "${PORT}" "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}" \
            "DEPLOY_PATH='${{ secrets.PROD_DEPLOY_PATH }}' DEPLOY_BRANCH='main' HEALTHCHECK_BASE_URL='https://nekomata.moe' APP_IMAGE_REPO='${IMAGE_REPO}' APP_IMAGE_TAG='${IMAGE_TAG}' bash '${{ secrets.PROD_DEPLOY_PATH }}/ops/prod/deploy-prod.sh'"
