import{r as g,j as s}from"./react-core-BcR2_z_l.js";import{ag as X,P as K,o as Q,ab as ee,c as W,ae as A,g as Y,N as te,a as T,ah as se,V as L,ad as re,ac as ne,ai as oe,S as ie,aj as ae,ak as ce,al as le,am as ue,an as de,ao as he,h as O,D as ge,ap as me,aq as fe,ar as pe}from"./lexical-CVusBMfS.js";import{u as ve,L as we}from"./ContentEditable-BX3pcmlG.js";import{N as xe,L as ye,K as Ee}from"./index-DVZfbOhf.js";import{b as U,c as ze}from"./PlaygroundNodes-ChCl_XRL.js";import"./index-ntR5v_s2.js";import"./mui-WkDK9qS1.js";const be="data:image/svg+xml,%3c?xml%20version='1.0'%20encoding='utf-8'?%3e%3c!--%20Uploaded%20to:%20SVG%20Repo,%20www.svgrepo.com,%20Generator:%20SVG%20Repo%20Mixer%20Tools%20--%3e%3csvg%20width='800px'%20height='800px'%20viewBox='0%200%2024%2024'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M22%203H2v18h20v-2h-2v-2h2v-2h-2v-2h2v-2h-2V9h2V7h-2V5h2V3zm-2%204v2h-2v2h2v2h-2v2h2v2h-2v2H4V5h14v2h2zm-6%202h-2v2h-2v2H8v2H6v2h2v-2h2v-2h2v-2h2v2h2v-2h-2V9zM6%207h2v2H6V7z'%20fill='%23000000'/%3e%3c/svg%3e";function _(h,l,u){return Math.min(Math.max(h,l),u)}const n={east:1,north:8,south:2,west:4};function Ce({onResizeStart:h,onResizeEnd:l,buttonRef:u,imageRef:p,maxWidth:D,editor:S,showCaption:y,setShowCaption:C,captionsEnabled:H}){const w=g.useRef(null),R=g.useRef({priority:"",value:"default"}),N=g.useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),m=S.getRootElement(),j=D||(m!==null?m.getBoundingClientRect().width-20:100),E=m!==null?m.getBoundingClientRect().height-20:100,v=100,P=100,r=e=>{const o=e===n.east||e===n.west,t=e===n.north||e===n.south,x=e&n.north&&e&n.west||e&n.south&&e&n.east,f=o?"ew":t?"ns":x?"nwse":"nesw";m!==null&&m.style.setProperty("cursor",`${f}-resize`,"important"),document.body!==null&&(document.body.style.setProperty("cursor",`${f}-resize`,"important"),R.current.value=document.body.style.getPropertyValue("-webkit-user-select"),R.current.priority=document.body.style.getPropertyPriority("-webkit-user-select"),document.body.style.setProperty("-webkit-user-select","none","important"))},M=()=>{m!==null&&m.style.setProperty("cursor","text"),document.body!==null&&(document.body.style.setProperty("cursor","default"),document.body.style.setProperty("-webkit-user-select",R.current.value,R.current.priority))},z=(e,o)=>{if(!S.isEditable())return;const t=p.current,x=w.current;if(t!==null&&x!==null){e.preventDefault();const{width:f,height:b}=t.getBoundingClientRect(),d=X(t),c=N.current;c.startWidth=f,c.startHeight=b,c.ratio=f/b,c.currentWidth=f,c.currentHeight=b,c.startX=e.clientX/d,c.startY=e.clientY/d,c.isResizing=!0,c.direction=o,r(o),h(),x.classList.add("image-control-wrapper--resizing"),t.style.height=`${b}px`,t.style.width=`${f}px`,document.addEventListener("pointermove",k),document.addEventListener("pointerup",V)}},k=e=>{const o=p.current,t=N.current,x=t.direction&(n.east|n.west),f=t.direction&(n.south|n.north);if(o!==null&&t.isResizing){const b=X(o);if(x&&f){let d=Math.floor(t.startX-e.clientX/b);d=t.direction&n.east?-d:d;const c=_(t.startWidth+d,v,j),$=c/t.ratio;o.style.width=`${c}px`,o.style.height=`${$}px`,t.currentHeight=$,t.currentWidth=c}else if(f){let d=Math.floor(t.startY-e.clientY/b);d=t.direction&n.south?-d:d;const c=_(t.startHeight+d,P,E);o.style.height=`${c}px`,t.currentHeight=c}else{let d=Math.floor(t.startX-e.clientX/b);d=t.direction&n.east?-d:d;const c=_(t.startWidth+d,v,j);o.style.width=`${c}px`,t.currentWidth=c}}},V=()=>{const e=p.current,o=N.current,t=w.current;if(e!==null&&t!==null&&o.isResizing){const x=o.currentWidth,f=o.currentHeight;o.startWidth=0,o.startHeight=0,o.ratio=0,o.startX=0,o.startY=0,o.currentWidth=0,o.currentHeight=0,o.isResizing=!1,t.classList.remove("image-control-wrapper--resizing"),M(),l(x,f),document.removeEventListener("pointermove",k),document.removeEventListener("pointerup",V)}};return s.jsxs("div",{ref:w,children:[!y&&H&&s.jsx("button",{className:"image-caption-button",ref:u,onClick:()=>{C(!y)},children:"Add Caption"}),s.jsx("div",{className:"image-resizer image-resizer-n",onPointerDown:e=>{z(e,n.north)}}),s.jsx("div",{className:"image-resizer image-resizer-ne",onPointerDown:e=>{z(e,n.north|n.east)}}),s.jsx("div",{className:"image-resizer image-resizer-e",onPointerDown:e=>{z(e,n.east)}}),s.jsx("div",{className:"image-resizer image-resizer-se",onPointerDown:e=>{z(e,n.south|n.east)}}),s.jsx("div",{className:"image-resizer image-resizer-s",onPointerDown:e=>{z(e,n.south)}}),s.jsx("div",{className:"image-resizer image-resizer-sw",onPointerDown:e=>{z(e,n.south|n.west)}}),s.jsx("div",{className:"image-resizer image-resizer-w",onPointerDown:e=>{z(e,n.west)}}),s.jsx("div",{className:"image-resizer image-resizer-nw",onPointerDown:e=>{z(e,n.north|n.west)}})]})}const Re=h=>!h.error,G=new Map,F=he("RIGHT_CLICK_IMAGE_COMMAND");function je({setShowCaption:h}){const[l]=Q();return g.useEffect(()=>l.registerCommand(fe,()=>(ze()&&h(!1),!1),pe)),null}function He(h){let l=G.get(h);if(l&&"error"in l&&typeof l.error=="boolean")return l;throw l||(l=new Promise(u=>{const p=new Image;p.src=h,p.onload=()=>u({error:!1,height:p.naturalHeight,width:p.naturalWidth}),p.onerror=()=>u({error:!0})}).then(u=>(G.set(h,u),u)),G.set(h,l),l)}function Ne(h){return h.toLowerCase().endsWith(".svg")}function Se({altText:h,className:l,imageRef:u,src:p,width:D,height:S,maxWidth:y,onError:C}){const H=Ne(p),w=He(p);if(g.useEffect(()=>{w.error&&C()},[w.error,C]),w.error)return s.jsx(J,{});const N=(()=>{if(!H)return{height:S,maxWidth:y,width:D};if(!Re(w))return{height:S,maxWidth:y,width:D};const m=w.width,j=w.height;let E=m,v=j;if(E>y){const r=y/E;E=y,v=Math.round(v*r)}const P=500;if(v>P){const r=P/v;v=P,E=Math.round(E*r)}return{height:v,maxWidth:y,width:E}})();return s.jsx("img",{className:l||void 0,src:p,alt:h,ref:u,style:N,onError:C,draggable:"false"})}function J(){return s.jsx("img",{src:be,style:{height:200,opacity:.2,width:200},draggable:"false",alt:"Broken image"})}function q(){}function $e({src:h,altText:l,nodeKey:u,width:p,height:D,maxWidth:S,resizable:y,showCaption:C,caption:H,captionsEnabled:w}){const R=g.useRef(null),N=g.useRef(null),[m,j,E]=K(u),[v,P]=g.useState(!1),[r]=Q(),M=g.useRef(null),[z,k]=g.useState(!1),V=ee(),e=g.useMemo(()=>m&&r.getEditorState().read(()=>{const i=W();return A(i)&&i.has(u)}),[r,m,u]),o=g.useCallback(i=>{const a=W(),I=N.current;if(A(a)&&a.has(u)&&a.getNodes().length===1){if(C)return Y(null),i.preventDefault(),H.focus(),!0;if(I!==null&&I!==document.activeElement)return i.preventDefault(),I.focus(),!0}return!1},[H,u,C]),t=g.useCallback(i=>M.current===H||N.current===i.target?(Y(null),r.update(()=>{j(!0);const a=r.getRootElement();a!==null&&a.focus()}),!0):!1,[H,r,j]),x=g.useCallback(i=>{const a=i;return v?!0:a.target===R.current?(a.shiftKey?j(!m):(E(),j(!0)),!0):!1},[v,m,j,E]),f=g.useCallback(i=>{r.getEditorState().read(()=>{const a=W();i.target.tagName==="IMG"&&te(a)&&a.getNodes().length===1&&r.dispatchCommand(F,i)})},[r]);g.useEffect(()=>T(r.registerCommand(re,(i,a)=>(M.current=a,!1),L),r.registerCommand(se,i=>i.target===R.current?(i.preventDefault(),!0):!1,L)),[r]),g.useEffect(()=>{let i=q;return T(r.registerCommand(ie,x,L),r.registerCommand(F,x,L),r.registerCommand(oe,o,L),r.registerCommand(ne,t,L),r.registerRootListener(a=>{i(),i=q,a&&(a.addEventListener("contextmenu",f),i=()=>a.removeEventListener("contextmenu",f))}),()=>i())},[r,o,t,x,f]);const b=i=>{r.update(()=>{const a=O(u);U(a)&&(a.setShowCaption(i),i&&a.__caption.update(()=>{W()||ge().selectEnd()}))})},d=(i,a)=>{setTimeout(()=>{P(!1)},200),r.update(()=>{const I=O(u);U(I)&&I.setWidthAndHeight(i,a)},{tag:me}),r.focus()},c=()=>{P(!0)},{historyState:$}=ve(),Z=e&&!v,B=(m||v)&&V;return s.jsx(g.Suspense,{fallback:null,children:s.jsxs(s.Fragment,{children:[s.jsx("div",{draggable:Z,children:z?s.jsx(J,{}):s.jsx(Se,{className:B?`focused ${e?"draggable":""}`:null,src:h,altText:l,imageRef:R,width:p,height:D,maxWidth:S,onError:()=>k(!0)})}),C&&s.jsx("div",{className:"image-caption-container",children:s.jsxs(ae,{initialEditor:H,children:[s.jsx(je,{setShowCaption:b}),s.jsx(xe,{}),s.jsx(ye,{}),s.jsx(ce,{}),s.jsx(Ee,{}),s.jsx(le,{externalHistoryState:$}),s.jsx(ue,{contentEditable:s.jsx(we,{placeholder:"Enter a caption...",placeholderClassName:"ImageNode__placeholder",className:"ImageNode__contentEditable"}),ErrorBoundary:de})]})}),y&&e&&B&&s.jsx(Ce,{showCaption:C,setShowCaption:b,editor:r,buttonRef:N,imageRef:R,maxWidth:S,onResizeStart:c,onResizeEnd:d,captionsEnabled:!z&&w})]})})}export{F as RIGHT_CLICK_IMAGE_COMMAND,$e as default};
