import{k as Te,i as Fe,r as d,j as e}from"./react-core-BcR2_z_l.js";import{D as Ce}from"./DashboardShell-BZQMplB5.js";import{B as R}from"./badge-CX6RuieY.js";import{B as v}from"./button-C7iHbTqw.js";import{D as De,a as we,b as Ie,c as ye,d as Pe}from"./dialog-CLWEkP9q.js";import{I as P}from"./input-BfSJiKKQ.js";import{L as f}from"./label-BwT1z_RF.js";import{S as Z,a as _,b as ee,c as te,d as b}from"./select-BOMyCGLP.js";import{T as Le,a as Ae,b as L,c as N,d as Ee,e as h}from"./table-DMhxaLRi.js";import{M as ae,a as se,b as re}from"./mui-date-time-fields-DDmsgWL7.js";import{g as Me,d as V}from"./index-ntR5v_s2.js";import{a as ie}from"./date-D79tpn1j.js";import{u as $e}from"./use-page-meta-ewLab265.js";import{t as A}from"./use-toast-DeMRPCeJ.js";import"./ThemedSvgLogo-CGFMwyp6.js";import"./createLucideIcon-M1JG7EBz.js";import"./url-safety-Py24cS-5.js";import"./Footer-C9y59CM9.js";import"./avatar-CVZSwVae.js";import"./index-Xj-Q384k.js";import"./shield-DlmGTLiS.js";import"./index-BMIt2_cw.js";import"./index-DZ2Ey5_7.js";import"./index-CHWtszJ3.js";import"./chevron-right-CrdESc7p.js";import"./check-Cyy403AY.js";import"./users-ok7q4J4c.js";import"./info-BTb-jBiG.js";import"./book-open-CG_mViAI.js";import"./ThemedSvgMaskIcon-B_IYD_H5.js";import"./globe-CRGpuS2E.js";import"./message-circle-qqsIJunn.js";import"./x-BpqL4Bns.js";import"./index-CwaKb5FF.js";import"./mui-WkDK9qS1.js";import"./separator-CDy1CE57.js";import"./skeleton-DbpZ9Rjt.js";import"./search-ranking-cq4don08.js";import"./use-dynamic-synopsis-clamp-DpjBDBPb.js";import"./access-control-C6qZ0ZhA.js";import"./chevron-down-Mfh0mWaz.js";const S=i=>String(i).padStart(2,"0"),q=i=>`${i.getFullYear()}-${S(i.getMonth()+1)}-${S(i.getDate())}`,oe=i=>{if(!i)return"";const s=new Date(i);return Number.isNaN(s.getTime())?"":`${q(s)}T${S(s.getHours())}:${S(s.getMinutes())}`},E=i=>{const[s,n]=i.split("T");if(!s)return{date:null,time:""};const[p,g,u]=s.split("-").map(j=>Number(j));return!p||!g||!u?{date:null,time:""}:{date:new Date(p,g-1,u),time:n||""}},ne=(i,s="00:00")=>{const[n,p]=(i||s).split(":"),g=Number(n),u=Number(p),j=new Date;return j.setHours(Number.isFinite(g)?g:0,Number.isFinite(u)?u:0,0,0),j},ke=i=>{const s=Number(i||"");return!Number.isFinite(s)||s<1?1:Math.floor(s)},de=i=>{const s=Number(i||"");return!Number.isFinite(s)||s<10?50:Math.min(Math.floor(s),100)},U=i=>{const s=String(i||"").trim().toLowerCase();return["all","success","failed","denied"].includes(s)?s:"all"},Ft=()=>{$e({title:"Audit Log",noIndex:!0});const i=Te(),s=Me(),[n,p]=Fe(),[g,u]=d.useState([]),[j,I]=d.useState(0),[T,B]=d.useState(!0),[y,F]=d.useState(""),[C,z]=d.useState(!1),[le,ce]=d.useState(0),[l,O]=d.useState(null),[me,M]=d.useState(null),[ue,xe]=d.useState(!0),[r,x]=d.useState({q:"",action:"",resource:"",actorId:"",status:"all",dateFrom:"",dateTo:"",limit:"50"}),D=ke(n.get("page")),H=de(n.get("limit")),$=Math.max(1,Math.ceil(j/Math.max(H,1))),X=E(r.dateFrom),J=E(r.dateTo),he=ne(X.time||"00:00"),pe=ne(J.time||"00:00"),Y=(t,a)=>{x(o=>{if(!a)return{...o,[t]:""};const{time:m}=E(o[t]),c=m||"00:00";return{...o,[t]:`${q(a)}T${c}`}})},G=(t,a)=>{if(!a||Number.isNaN(a.getTime()))return;const o=`${S(a.getHours())}:${S(a.getMinutes())}`;x(m=>{const{date:c}=E(m[t]);return c?{...m,[t]:`${q(c)}T${o}`}:m})};d.useEffect(()=>{x({q:n.get("q")||"",action:n.get("action")||"",resource:n.get("resource")||"",actorId:n.get("actorId")||"",status:U(n.get("status")),dateFrom:oe(n.get("dateFrom")||""),dateTo:oe(n.get("dateTo")||""),limit:String(de(n.get("limit")))})},[n]),d.useEffect(()=>{(async()=>{try{const a=await V(s,"/api/me",{auth:!0});if(!a.ok){M(null);return}const o=await a.json();M(o)}catch{M(null)}finally{xe(!1)}})()},[s]),d.useEffect(()=>{let t=!0;return(async()=>{B(!0),F(""),z(!1);try{const o=new URLSearchParams(n);o.get("page")||o.set("page","1"),o.get("limit")||o.set("limit","50");const m=await V(s,`/api/audit-log?${o.toString()}`,{auth:!0});if(!t)return;if(m.status===403){z(!0),u([]),I(0);return}if(!m.ok){F("Não foi possível carregar o audit log."),u([]),I(0);return}const c=await m.json();u(Array.isArray(c.entries)?c.entries:[]),I(Number.isFinite(c.total)?Number(c.total):0)}catch{if(!t)return;F("Erro de conexão ao carregar o audit log."),u([]),I(0)}finally{t&&B(!1)}})(),()=>{t=!1}},[s,le,n]);const K=t=>t==="failed"?"bg-red-500/20 text-red-200":t==="denied"?"bg-amber-500/20 text-amber-200":"bg-emerald-500/20 text-emerald-200",ge=()=>{const t=new URLSearchParams;if(t.set("page","1"),t.set("limit",r.limit||"50"),r.q.trim()&&t.set("q",r.q.trim()),r.action.trim()&&t.set("action",r.action.trim()),r.resource.trim()&&t.set("resource",r.resource.trim()),r.actorId.trim()&&t.set("actorId",r.actorId.trim()),U(r.status)!=="all"&&t.set("status",U(r.status)),r.dateFrom){const a=new Date(r.dateFrom);Number.isNaN(a.getTime())||t.set("dateFrom",a.toISOString())}if(r.dateTo){const a=new Date(r.dateTo);Number.isNaN(a.getTime())||t.set("dateTo",a.toISOString())}p(t)},je=()=>{x({q:"",action:"",resource:"",actorId:"",status:"all",dateFrom:"",dateTo:"",limit:"50"}),p(new URLSearchParams({page:"1",limit:"50"}))},Q=t=>{const a=Math.min(Math.max(t,1),$),o=new URLSearchParams(n);o.set("page",String(a)),o.set("limit",String(H)),p(o)},fe=d.useMemo(()=>j.toLocaleString("pt-BR"),[j]),[k,W]=d.useState(!1),be=async()=>{if(!k){W(!0);try{const t=new URLSearchParams(n);t.set("format","csv");const a=await V(s,`/api/audit-log?${t.toString()}`,{auth:!0});if(!a.ok){F("Não foi possível exportar o CSV."),A({title:"Falha ao exportar CSV",description:"Não foi possível gerar o arquivo no momento.",variant:"destructive"});return}const o=a.headers.get("X-Audit-Export-Truncated")==="1";if(o){const ve=a.headers.get("X-Audit-Export-Count")||"",Se=a.headers.get("X-Audit-Export-Total")||"";A({title:"CSV exportado com limite",description:`Foram exportados ${ve||"10000"} de ${Se||"muitos"} eventos.`})}const m=await a.blob(),c=window.URL.createObjectURL(m),w=document.createElement("a");w.href=c;const Ne=new Date().toISOString().slice(0,10);w.download=`audit-log-${Ne}.csv`,document.body.appendChild(w),w.click(),document.body.removeChild(w),window.URL.revokeObjectURL(c),o||A({title:"CSV exportado",description:"O arquivo foi gerado com sucesso.",intent:"success"})}catch{F("Erro ao exportar CSV."),A({title:"Falha ao exportar CSV",description:"Ocorreu um erro inesperado durante a exportação.",variant:"destructive"})}finally{W(!1)}}};return e.jsxs(e.Fragment,{children:[e.jsx(Ce,{currentUser:me,isLoadingUser:ue,onUserCardClick:()=>i("/dashboard/usuarios?edit=me"),children:e.jsx("main",{className:"pt-24",children:e.jsxs("section",{className:"mx-auto w-full max-w-7xl px-6 pb-20 md:px-10",children:[e.jsxs("header",{className:"flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"inline-flex items-center gap-3 rounded-full border border-border/60 bg-card/60 px-4 py-2 text-xs uppercase tracking-[0.3em] text-muted-foreground animate-fade-in",children:"Audit Log"}),e.jsx("h1",{className:"mt-4 text-3xl font-semibold lg:text-4xl animate-slide-up",children:"Registro de Auditoria"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground animate-slide-up opacity-0",style:{animationDelay:"0.2s"},children:"Eventos mutáveis e de segurança dos últimos 30 dias."})]}),e.jsxs("div",{className:"flex items-center gap-3 animate-slide-up opacity-0",style:{animationDelay:"0.24s"},children:[e.jsxs(R,{className:"bg-card/80 text-muted-foreground",children:[fe," eventos"]}),e.jsx(v,{variant:"outline",onClick:()=>{be()},disabled:k||C,children:k?"Exportando...":"Exportar CSV"}),e.jsx(v,{variant:"outline",onClick:()=>ce(t=>t+1),children:"Atualizar"})]})]}),e.jsxs("div",{className:"mt-8 rounded-2xl border border-border/60 bg-card/60 p-4 md:p-5 animate-slide-up opacity-0",style:{animationDelay:"0.28s"},children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-q",children:"Busca"}),e.jsx(P,{id:"audit-q",value:r.q,onChange:t=>x(a=>({...a,q:t.target.value})),placeholder:"ator, IP, meta..."})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-action",children:"Ação"}),e.jsx(P,{id:"audit-action",value:r.action,onChange:t=>x(a=>({...a,action:t.target.value})),placeholder:"ex.: posts.update"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-resource",children:"Recurso"}),e.jsx(P,{id:"audit-resource",value:r.resource,onChange:t=>x(a=>({...a,resource:t.target.value})),placeholder:"ex.: posts"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-actor",children:"Actor ID"}),e.jsx(P,{id:"audit-actor",value:r.actorId,onChange:t=>x(a=>({...a,actorId:t.target.value})),placeholder:"ID do Discord"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{children:"Status"}),e.jsxs(Z,{value:r.status,onValueChange:t=>x(a=>({...a,status:t})),children:[e.jsx(_,{children:e.jsx(ee,{placeholder:"Todos"})}),e.jsxs(te,{children:[e.jsx(b,{value:"all",children:"Todos"}),e.jsx(b,{value:"success",children:"Sucesso"}),e.jsx(b,{value:"failed",children:"Falha"}),e.jsx(b,{value:"denied",children:"Negado"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-date-from",children:"Data inicial"}),e.jsx(ae,{children:e.jsxs("div",{className:"grid gap-2 sm:grid-cols-2",children:[e.jsx(se,{id:"audit-date-from",value:X.date,onChange:t=>Y("dateFrom",t)}),e.jsx(re,{id:"audit-date-from-time",value:he,onChange:t=>G("dateFrom",t),disabled:!r.dateFrom})]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{htmlFor:"audit-date-to",children:"Data final"}),e.jsx(ae,{children:e.jsxs("div",{className:"grid gap-2 sm:grid-cols-2",children:[e.jsx(se,{id:"audit-date-to",value:J.date,onChange:t=>Y("dateTo",t)}),e.jsx(re,{id:"audit-date-to-time",value:pe,onChange:t=>G("dateTo",t),disabled:!r.dateTo})]})})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(f,{children:"Itens por página"}),e.jsxs(Z,{value:r.limit,onValueChange:t=>x(a=>({...a,limit:t})),children:[e.jsx(_,{children:e.jsx(ee,{placeholder:"50"})}),e.jsxs(te,{children:[e.jsx(b,{value:"10",children:"10"}),e.jsx(b,{value:"20",children:"20"}),e.jsx(b,{value:"50",children:"50"}),e.jsx(b,{value:"100",children:"100"})]})]})]})]}),e.jsxs("div",{className:"mt-4 flex flex-wrap items-center gap-2",children:[e.jsx(v,{onClick:ge,children:"Aplicar filtros"}),e.jsx(v,{variant:"outline",onClick:je,children:"Limpar"})]})]}),e.jsxs("div",{className:"mt-6 rounded-2xl border border-border/60 bg-card/60 p-2 md:p-4 animate-slide-up opacity-0",style:{animationDelay:"0.32s"},children:[C?e.jsx("div",{className:"rounded-xl border border-amber-500/30 bg-amber-500/10 px-4 py-6 text-sm text-amber-100",children:"Acesso negado. Apenas o dono pode visualizar o audit log."}):null,y&&!C?e.jsx("div",{className:"rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-6 text-sm text-red-100",children:y}):null,!C&&!y?e.jsxs(Le,{children:[e.jsx(Ae,{children:e.jsxs(L,{children:[e.jsx(N,{children:"Data/Hora"}),e.jsx(N,{children:"Ator"}),e.jsx(N,{children:"Ação"}),e.jsx(N,{children:"Recurso"}),e.jsx(N,{children:"Status"}),e.jsx(N,{children:"IP"}),e.jsx(N,{children:"Alvo"}),e.jsx(N,{className:"text-right",children:"Detalhes"})]})}),e.jsxs(Ee,{children:[T?e.jsx(L,{children:e.jsx(h,{colSpan:8,className:"text-center text-muted-foreground animate-pulse",children:"Carregando audit log..."})}):null,!T&&g.length===0?e.jsx(L,{children:e.jsx(h,{colSpan:8,className:"text-center text-muted-foreground",children:"Nenhum evento encontrado para os filtros atuais."})}):null,!T&&g.map(t=>e.jsxs(L,{children:[e.jsx(h,{children:ie(t.ts)}),e.jsxs(h,{className:"max-w-44",children:[e.jsx("div",{className:"truncate",children:t.actorName||"anonymous"}),e.jsx("div",{className:"truncate text-xs text-muted-foreground",children:t.actorId})]}),e.jsx(h,{className:"font-mono text-xs",children:t.action}),e.jsxs(h,{children:[e.jsx("div",{children:t.resource||"-"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:t.resourceId||"-"})]}),e.jsx(h,{children:e.jsx(R,{className:K(t.status),children:t.status})}),e.jsx(h,{className:"font-mono text-xs",children:t.ip||"-"}),e.jsx(h,{className:"font-mono text-xs",children:t.resourceId||"-"}),e.jsx(h,{className:"text-right",children:e.jsx(v,{size:"sm",variant:"outline",onClick:()=>O(t),children:"Ver"})})]},t.id))]})]}):null]}),!C&&!y?e.jsxs("div",{className:"mt-4 flex items-center justify-between gap-3 animate-slide-up opacity-0",style:{animationDelay:"0.36s"},children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Página ",D," de ",$]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{variant:"outline",size:"sm",onClick:()=>Q(D-1),disabled:D<=1||T,children:"Anterior"}),e.jsx(v,{variant:"outline",size:"sm",onClick:()=>Q(D+1),disabled:D>=$||T,children:"Próxima"})]})]}):null]})})}),e.jsx(De,{open:!!l,onOpenChange:t=>!t&&O(null),children:e.jsxs(we,{className:"w-[95vw] max-w-3xl",children:[e.jsxs(Ie,{children:[e.jsx(ye,{children:"Detalhes do evento"}),e.jsx(Pe,{children:l?`${l.action} • ${ie(l.ts)}`:""})]}),l?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid gap-2 rounded-xl border border-border/60 bg-card/60 p-4 text-sm md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Ator"}),e.jsxs("p",{children:[l.actorName," (",l.actorId,")"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Request ID"}),e.jsx("p",{className:"font-mono text-xs",children:l.requestId||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"IP"}),e.jsx("p",{className:"font-mono text-xs",children:l.ip||"-"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Status"}),e.jsx(R,{className:K(l.status),children:l.status})]})]}),e.jsxs("div",{className:"rounded-xl border border-border/60 bg-card/80 p-4",children:[e.jsx("p",{className:"mb-2 text-sm text-muted-foreground",children:"Meta"}),e.jsx("pre",{className:"max-h-[45vh] overflow-auto text-xs leading-relaxed text-foreground",children:JSON.stringify(l.meta||{},null,2)})]})]}):null]})})]})};export{Ft as default};
