import{r as i,u as V,j as t}from"./react-core-BcR2_z_l.js";import{M as W,A as K,a as Q,b as X}from"./avatar-CVZSwVae.js";import{B as C}from"./button-C7iHbTqw.js";import{C as Y,b as Z,c as _,a as ee}from"./card-VD61BBwz.js";import{A as te,a as se,b as ae,c as re,d as ie,e as oe,f as ne,g as le}from"./alert-dialog-ugflDUIb.js";import{I as z}from"./input-BfSJiKKQ.js";import{S as ce}from"./separator-CDy1CE57.js";import{T as de}from"./textarea-BwWmg86h.js";import{t as f}from"./use-toast-DeMRPCeJ.js";import{g as me,d as y}from"./index-ntR5v_s2.js";import{a as ue}from"./date-D79tpn1j.js";import{c as pe}from"./createLucideIcon-M1JG7EBz.js";const xe=pe("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),fe=c=>{const l=new Map;c.forEach(a=>{l.set(a.id,{...a,replies:[]})});const d=[];l.forEach(a=>{a.parentId&&l.has(a.parentId)?l.get(a.parentId)?.replies.push(a):d.push(a)});const u=a=>{a.sort((p,h)=>new Date(p.createdAt).getTime()-new Date(h.createdAt).getTime()),a.forEach(p=>u(p.replies))};return u(d),d},he=c=>c.split(" ").map(l=>l.charAt(0)).join("").slice(0,2).toUpperCase(),Te=({targetType:c,targetId:l,chapterNumber:d,volume:u})=>{const a=me(),[p,h]=i.useState([]),[P,k]=i.useState(!0),[T,v]=i.useState(""),[j,w]=i.useState(null),[o,g]=i.useState({name:"",email:"",content:"",website:""}),[I,F]=i.useState(!1),[ve,q]=i.useState(null),[N,H]=i.useState(!1),[S,A]=i.useState(null),[b,L]=i.useState(!1),M=i.useMemo(()=>fe(p),[p]),R=V(),B=i.useRef(null),E=i.useCallback(async(e={})=>{const{showLoading:s=!0}=e;try{s&&k(!0);const r=new URLSearchParams({type:c,id:l});c==="chapter"&&Number.isFinite(d)&&(r.set("chapter",String(d)),Number.isFinite(u)&&r.set("volume",String(u)));const m=await y(a,`/api/public/comments?${r.toString()}`);if(!m.ok){s&&h([]);return}const n=await m.json();h(Array.isArray(n.comments)?n.comments:[])}catch{s&&h([])}finally{s&&k(!1)}},[a,d,l,c,u]);i.useEffect(()=>{E()},[E]),i.useEffect(()=>{const e=R.hash||"";if(!e.startsWith("#comment-")||B.current===e)return;const s=e.slice(1),r=document.getElementById(s);r&&(r.scrollIntoView({behavior:"smooth",block:"center"}),B.current=e)},[p,R.hash]),i.useEffect(()=>{let e=!0;return(async()=>{try{const r=await y(a,"/api/public/me",{auth:!0});if(!r.ok)return;const m=await r.json(),n=m?.user??m;if(!n||!e)return;const x=Array.isArray(n.permissions)?n.permissions:[],O=x.includes("*")||x.includes("comentarios")||x.includes("posts")||x.includes("projetos");q({name:n.name||"",email:n.email||"",permissions:x}),H(O),O&&g(D=>({...D,name:n.name||D.name,email:n.email||D.email}))}catch{}})(),()=>{e=!1}},[a]);const $=async()=>{if(!o.name.trim()||!o.content.trim()){v("Preencha nome e comentário.");return}F(!0),v("");try{const e={targetType:c,targetId:l,name:o.name.trim(),content:o.content.trim()},s=o.email.trim();s&&(e.email=s),j&&(e.parentId=j.id),o.website&&(e.website=o.website),c==="chapter"&&Number.isFinite(d)&&(e.chapterNumber=Number(d),Number.isFinite(u)&&(e.volume=Number(u)));const r=await y(a,"/api/public/comments",{method:"POST",headers:{"Content-Type":"application/json"},auth:!0,body:JSON.stringify(e)});if(!r.ok){v("Não foi possível enviar o comentário. Tente novamente."),f({title:"Não foi possível enviar o comentário",variant:"destructive"});return}const m=await r.json(),x=String(m?.comment?.status||"").toLowerCase()==="approved";g({name:"",email:"",content:"",website:""}),w(null),x?(await E({showLoading:!1}),v("Comentário publicado."),f({title:"Comentário publicado",description:"Seu comentário já está visível na página.",intent:"success"})):(v("Comentário enviado! Ele ficará visível após aprovação."),f({title:"Comentário enviado",description:"Ele ficará visível após aprovação da equipe.",intent:"success"}))}catch{v("Não foi possível enviar o comentário. Tente novamente."),f({title:"Não foi possível enviar o comentário",variant:"destructive"})}finally{F(!1)}},G=e=>{A(e)},J=async()=>{if(!S||b)return;const e=S.id;L(!0);try{(await y(a,`/api/comments/${e}`,{method:"DELETE",auth:!0})).ok?(h(r=>r.filter(m=>m.id!==e)),A(null),f({title:"Comentário excluído",description:"O comentário foi removido com sucesso.",intent:"success"})):f({title:"Não foi possível excluir o comentário",variant:"destructive"})}catch{f({title:"Não foi possível excluir o comentário",variant:"destructive"})}finally{L(!1)}},U=(e,s=0)=>t.jsxs("div",{id:`comment-${e.id}`,className:s>0?"pl-6 border-l border-border/40":"",children:[t.jsxs("div",{className:"flex gap-3",children:[t.jsxs(K,{className:"h-10 w-10",children:[e.avatarUrl?t.jsx(Q,{src:e.avatarUrl,alt:e.name}):null,t.jsx(X,{children:he(e.name)})]}),t.jsxs("div",{className:"flex-1 space-y-1",children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-3 text-xs text-muted-foreground",children:[t.jsx("span",{className:"text-sm font-semibold text-foreground",children:e.name}),t.jsx("span",{children:ue(e.createdAt)})]}),t.jsx("p",{className:"text-sm text-muted-foreground whitespace-pre-line",children:e.content}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsxs(C,{type:"button",variant:"ghost",size:"sm",className:"h-auto px-2 text-xs",onClick:()=>w(e),children:[t.jsx(xe,{className:"mr-1 h-3 w-3"}),"Responder"]}),N?t.jsx(C,{type:"button",variant:"ghost",size:"sm",className:"h-auto px-2 text-xs text-red-400",onClick:()=>G(e),children:"Excluir"}):null]})]})]}),e.replies.length>0?t.jsx("div",{className:"mt-4 space-y-4",children:e.replies.map(r=>U(r,s+1))}):null]},e.id);return t.jsxs(t.Fragment,{children:[t.jsxs(Y,{className:"border-border bg-card",children:[t.jsx(Z,{children:t.jsx(_,{className:"text-lg",children:"Comentários"})}),t.jsxs(ee,{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[t.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[t.jsx(W,{className:"h-4 w-4 text-primary/70","aria-hidden":"true"}),N?"Como staff, seus comentários aparecem imediatamente.":"Os comentários passam por aprovação antes de aparecerem."]}),t.jsx("span",{className:"text-xs text-muted-foreground",children:"Avatar via Gravatar (quando e-mail for informado)."})]}),t.jsx(ce,{}),t.jsxs("div",{className:"space-y-3",children:[j?t.jsxs("div",{className:"rounded-xl border border-border/60 bg-background/60 px-3 py-2 text-xs text-muted-foreground",children:["Respondendo a ",t.jsx("span",{className:"font-semibold text-foreground",children:j.name}),".",t.jsx(C,{type:"button",variant:"ghost",size:"sm",className:"ml-2 h-auto px-2 text-xs",onClick:()=>w(null),children:"Cancelar"})]}):null,t.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[t.jsx(z,{placeholder:"Seu nome",value:o.name,onChange:e=>g(s=>({...s,name:e.target.value})),disabled:N}),t.jsx(z,{type:"email",placeholder:"Seu e-mail (opcional, usado para o Gravatar)",value:o.email,onChange:e=>g(s=>({...s,email:e.target.value})),disabled:N})]}),t.jsx("input",{className:"hidden",tabIndex:-1,autoComplete:"off",value:o.website,onChange:e=>g(s=>({...s,website:e.target.value})),"aria-hidden":"true"}),t.jsx(de,{placeholder:"Escreva seu comentário",value:o.content,onChange:e=>g(s=>({...s,content:e.target.value})),className:"min-h-[120px]"}),T?t.jsx("p",{className:"text-xs text-muted-foreground",children:T}):null,t.jsx("div",{className:"flex flex-wrap items-center gap-3",children:t.jsx(C,{onClick:$,disabled:I,children:I?"Enviando...":"Publicar comentário"})})]}),P?t.jsx("div",{className:"rounded-xl border border-border bg-background/60 p-4 text-sm text-muted-foreground",children:"Carregando comentários..."}):M.length===0?t.jsx("div",{className:"rounded-xl border border-border bg-background/60 p-4 text-sm text-muted-foreground",children:"Ainda não há comentários aprovados."}):t.jsx("div",{className:"space-y-6",children:M.map(e=>U(e))})]})]}),t.jsx(te,{open:!!S,onOpenChange:e=>{!e&&!b&&A(null)},children:t.jsxs(se,{children:[t.jsxs(ae,{children:[t.jsx(re,{children:"Excluir comentário?"}),t.jsx(ie,{children:"Esta ação remove o comentário permanentemente."})]}),t.jsxs(oe,{children:[t.jsx(ne,{disabled:b,children:"Cancelar"}),t.jsx(le,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:b,onClick:e=>{e.preventDefault(),J()},children:b?"Excluindo...":"Excluir"})]})]})})]})};export{Te as C};
